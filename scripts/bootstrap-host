#!/usr/bin/env -S nix shell nixpkgs#bash nixpkgs#age nixpkgs#openssl nixpkgs#coreutils nixpkgs#jq --command bash
set -euo pipefail

# Inputs
TARGET_HOSTNAME="${1:-}"
BOOTSTRAP_HOSTNAME="bootstrap.local"

if [[ -z "$TARGET_HOSTNAME" ]]; then
    echo "Usage: ./scripts/bootstrap-host <target-hostname>"
    exit 1
fi

# Paths
PROJECT_ROOT=$(pwd)
HOSTS_DIR="$PROJECT_ROOT/src/hosts"
TEMPLATE_DIR="$PROJECT_ROOT/template/host"
YUBIKEY_PUB="$PROJECT_ROOT/src/common/secrets/yubikey_identity.pub"
VARS_FILE="$PROJECT_ROOT/vars.nix"
SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"

# Resolve User early
SSH_USER=$(nix eval --raw -f "$VARS_FILE" username)

# ----------------------------------------------------------
# Helper Functions
# ----------------------------------------------------------

function prompt_key_local {
    echo ""
    echo "=================================================================="
    echo " ðŸ”Œ  ACTION REQUIRED: YUBIKEY -> LOCAL "
    echo "=================================================================="
    echo "Please plug your YubiKey into THIS machine (Local)."
    echo "Needed for: SSH Authentication / File Transfer"
    echo "------------------------------------------------------------------"
    read -r -p "Press [Enter] when the key is connected locally..."
}

function prompt_key_remote {
    echo ""
    echo "=================================================================="
    echo " ðŸ”Œ  ACTION REQUIRED: YUBIKEY -> REMOTE "
    echo "=================================================================="
    echo "Please plug your YubiKey into the TARGET machine ($1)."
    echo "Needed for: Identity Attestation (Decryption)"
    echo "------------------------------------------------------------------"
    read -r -p "Press [Enter] when the key is connected remotely..."
}

# ----------------------------------------------------------
# 0. Cleanup Trap
# ----------------------------------------------------------
ARTIFACTS=$(mktemp -d -t bootstrap-XXXXXX)

function cleanup {
    EXIT_CODE=$?
    echo ""
    echo "==> Cleaning up artifacts..."
    rm -rf "$ARTIFACTS"

    # Attempt remote cleanup (Best effort, as key might be in wrong place)
    echo "==> Attempting remote cleanup (ignoring errors if key is missing)..."
    ssh $SSH_OPTS "$SSH_USER@$BOOTSTRAP_HOSTNAME" "rm -f /tmp/verify.age /tmp/verified.txt /tmp/facter.json" 2>/dev/null || true
    ssh $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME" "rm -f /tmp/verify_final.age /tmp/verified_final.txt" 2>/dev/null || true

    exit "$EXIT_CODE"
}
trap cleanup EXIT INT TERM

########################################
# 1. Pre-flight & Scaffold
########################################
echo "==> Checking for $BOOTSTRAP_HOSTNAME..."
ping -c 1 -W 2 "$BOOTSTRAP_HOSTNAME" > /dev/null 2>&1 || (echo "Error: Host unreachable"; exit 1)

prompt_key_local
echo "==> Adding key to agent"
ssh-add -K

prompt_key_remote "$BOOTSTRAP_HOSTNAME"
echo "==> Adding key to agent"
ssh -t $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME" "ssh-add -K"

TARGET_DIR="$HOSTS_DIR/$TARGET_HOSTNAME"
if [ -d "$TARGET_DIR" ]; then
    echo "Error: Host directory $TARGET_DIR already exists."
    exit 1
fi

echo "==> Scaffolding $TARGET_DIR..."
mkdir -p "$HOSTS_DIR"
cp -r "$TEMPLATE_DIR" "$TARGET_DIR"

########################################
# 2. First Attestation & Disk Discovery
########################################
echo "==> Generating Challenge 1..."
CHALLENGE_1="$ARTIFACTS/c1.age"
echo "stage=pre-install host=$TARGET_HOSTNAME nonce=$(openssl rand -hex 32)" > "$ARTIFACTS/c1.txt"
age -r "$(head -1 "$YUBIKEY_PUB"|awk '{print $NF}')" -o "$CHALLENGE_1" "$ARTIFACTS/c1.txt"

# --- SWAP 1: LOCAL ---
prompt_key_local
echo "==> Uploading challenge to $BOOTSTRAP_HOSTNAME..."
scp $SSH_OPTS "$CHALLENGE_1" "$SSH_USER@$BOOTSTRAP_HOSTNAME:/tmp/verify.age"

# --- SWAP 2: REMOTE ---
prompt_key_remote "$BOOTSTRAP_HOSTNAME"
echo "==> Verifying identity on remote..."
# NOTE: If your SSH auth relies on the YubiKey, this step requires
# SSH ControlMaster (multiplexing) or a password fallback, as the key is now remote.

ssh -t $SSH_OPTS "$SSH_USER@$BOOTSTRAP_HOSTNAME" <<'EOF'
  set -euo pipefail
  echo "Decrypting..."
  age -d -i <(age-plugin-fido2-hmac -i | head -1 | awk '{print $NF}') /tmp/verify.age > /tmp/verified.txt
  echo "Scanning Hardware..."
  nixos-facter --json > /tmp/facter.json
EOF

# --- SWAP 3: LOCAL ---
prompt_key_local
echo "==> Retrieving proofs..."
scp $SSH_OPTS "$SSH_USER@$BOOTSTRAP_HOSTNAME:/tmp/verified.txt" "$ARTIFACTS/c1_returned.txt"
scp $SSH_OPTS "$SSH_USER@$BOOTSTRAP_HOSTNAME:/tmp/facter.json" "$TARGET_DIR/facter.json"

if ! cmp -s "$ARTIFACTS/c1.txt" "$ARTIFACTS/c1_returned.txt"; then
    echo "!!!!!! SECURITY ALERT !!!!!!"
    echo "Attestation Failed! Remote content does not match local challenge."
    exit 1
else
    echo "==> Identity confirmed."
fi

########################################
# 3. Interactive Disk Selection
########################################
echo "==> Available disks on $BOOTSTRAP_HOSTNAME:"
DISK_LIST=$(jq -r '.hardware.disks | to_entries[] | select(.value.size_bytes > 1000000000) | "\(.key) (\(.value.model // "Unknown") - \(.value.size_bytes / 1024 / 1024 / 1024 | floor)GB)"' "$TARGET_DIR/facter.json")

if [ -z "$DISK_LIST" ]; then
    echo "Error: No suitable disks found!"
    exit 1
fi

mapfile -t DISKS <<< "$DISK_LIST"
for i in "${!DISKS[@]}"; do
    echo "$((i+1))) ${DISKS[$i]}"
done

echo -n "Select disk for installation (1-${#DISKS[@]}): "
read -r CHOICE
SELECTED_DISK_STR="${DISKS[$((CHOICE-1))]}"
SELECTED_DISK=$(echo "$SELECTED_DISK_STR" | cut -d' ' -f1)

echo "==> Selected: /dev/$SELECTED_DISK"
sed -i "s|device = \"/dev/[^\"]*\"|device = \"/dev/$SELECTED_DISK\"|g" "$TARGET_DIR/disk-configuration.nix"

########################################
# 4. Execute Installation
########################################
# Key is already Local from previous step
echo "==> Starting installation on /dev/$SELECTED_DISK..."
nixos-anywhere \
  --flake ".#$TARGET_HOSTNAME" \
  --ssh-user "$SSH_USER" \
  --ssh-option "StrictHostKeyChecking=no" \
  --ssh-option "UserKnownHostsFile=/dev/null" \
  "$SSH_USER@$BOOTSTRAP_HOSTNAME"

########################################
# 5. POST-INSTALL CHALLENGE
########################################
echo "==> Waiting for reboot to $TARGET_HOSTNAME..."
until ssh $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME" exit 2>/dev/null; do sleep 5; done

echo "==> Generating Challenge 2..."
CHALLENGE_2="$ARTIFACTS/c2.age"
echo "stage=post-install host=$TARGET_HOSTNAME nonce=$(openssl rand -hex 32)" > "$ARTIFACTS/c2.txt"
age -r "$(head -1 "$YUBIKEY_PUB"|awk '{print $NF}')" -o "$CHALLENGE_2" "$ARTIFACTS/c2.txt"

# --- SWAP 4: LOCAL (Ensure it's still here) ---
# It should be local from the install step, but let's be safe.
prompt_key_local
echo "==> Uploading final challenge..."
scp $SSH_OPTS "$CHALLENGE_2" "$SSH_USER@$TARGET_HOSTNAME:/tmp/verify_final.age"

# --- SWAP 5: REMOTE ---
prompt_key_remote "$TARGET_HOSTNAME"
echo "==> Verifying new system identity..."
ssh -t $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME" "age -d -i <(age-plugin-fido2-hmac -i | head -1 | awk '{print $NF}') /tmp/verify_final.age > /tmp/verified_final.txt"

# --- SWAP 6: LOCAL ---
prompt_key_local
echo "==> Retrieving final proofs..."
scp $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME:/tmp/verified_final.txt" "$ARTIFACTS/c2_returned.txt"
scp $SSH_OPTS "$SSH_USER@$TARGET_HOSTNAME:/etc/ssh/ssh_host_ed25519_key.pub" "$TARGET_DIR/ssh_host_ed25519_key.pub"

if ! cmp -s "$ARTIFACTS/c2.txt" "$ARTIFACTS/c2_returned.txt"; then
    echo "!!!!!! SECURITY ALERT !!!!!!"
    echo "Post-Install Attestation Failed!"
    exit 1
else
    echo "==> Identity confirmed."
fi

echo "==> Success! Host $TARGET_HOSTNAME is ready."
